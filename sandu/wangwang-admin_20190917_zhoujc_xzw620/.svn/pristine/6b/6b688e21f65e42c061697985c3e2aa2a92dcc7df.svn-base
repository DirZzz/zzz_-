<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sandu.service.statisticsPlan.dao.PlanStatisticsHourMapper">

    <select id="selectHourPlanList" parameterType="com.sandu.api.statisticsPlan.model.PlanStatistics"
            resultType="com.sandu.api.statisticsPlan.model.PlanStatistics">
        select
        id,
        <if test="type == 1">
            sum(new_plan_count) newPlanCount,
        </if>
        <if test="type == 0">
            sum(IFNULL ( pc_use_plan_count, 0 ) + IFNULL ( mobile_use_plan_count, 0 )) AS usePlanCount,
        </if>
        start_time
        from
        data_statistics.bigdata_recommended_plan_statistics_2b_hour
        where is_deleted = 0
        <if test="type == 1">
            and new_plan_count &lt;&gt; 0
        </if>
        <if test="type == 0">
            and (IFNULL (pc_use_plan_count, 0) + IFNULL (mobile_use_plan_count, 0)) &lt;&gt; 0
        </if>
        <if test="planType != null">
            and plan_type = #{planType,jdbcType=INTEGER}
        </if>
        <if test="listGroupStyleId != null and listGroupStyleId.size > 0">
            and design_style_id in
            <foreach collection="listGroupStyleId" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="spaceCommonType != null">
            and space_common_type = #{spaceCommonType,jdbcType=INTEGER}
        </if>
        <if test="companyId != null">
            and company_id = #{companyId,jdbcType=INTEGER}
        </if>
        <if test="planSource != null  and planSource != '' ">
            and plan_source = #{planSource,jdbcType=VARCHAR}
        </if>
        <if test="time == 0">
            and TO_DAYS( NOW( ) ) - TO_DAYS(start_time) = 1
        </if>
        group by start_time
        ORDER BY start_time DESC
    </select>

    <select id="selectHourPlanTotal" parameterType="com.sandu.api.statisticsPlan.model.PlanStatistics"
            resultType="com.sandu.api.statisticsPlan.model.PlanStatistics">
        select
        sum(new_plan_count) as newPlanTotal,
        sum(IFNULL ( pc_use_plan_count, 0 ) + IFNULL ( mobile_use_plan_count, 0 )) as usePlanTotal
        from
        data_statistics.bigdata_recommended_plan_statistics_2b_hour
        where is_deleted = 0
        <if test="planType != null">
            and plan_type = #{planType,jdbcType=INTEGER}
        </if>
        <if test="listGroupStyleId != null and listGroupStyleId.size > 0">
            and design_style_id in
            <foreach collection="listGroupStyleId" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="spaceCommonType != null">
            and space_common_type = #{spaceCommonType,jdbcType=INTEGER}
        </if>
        <if test="companyId != null">
            and company_id = #{companyId,jdbcType=INTEGER}
        </if>
        <if test="planSource != null  and planSource != '' ">
            and plan_source = #{planSource,jdbcType=VARCHAR}
        </if>
        <if test="time == 0">
            and TO_DAYS( NOW( ) ) - TO_DAYS(start_time) = 1
        </if>
    </select>


    <select id="selectHourPlanChart" parameterType="com.sandu.api.statisticsPlan.model.PlanStatistics"
            resultType="com.sandu.api.statisticsPlan.model.PlanStatistics">
        SELECT
        a.timehoure as startTime,
        IFNULL ( c.newCount, 0 ) as newPlanCount,
        IFNULL ( c.useCount, 0 ) as usePlanCount
        FROM
        (select 0 AS timehoure union select 1 union select 2 union select 3 union select 4 union select 5 union
        select 6 union select 7 union select 8 union select 9 union select 10 union select 11 union select 12 union
        select 13 union select 14 union select 15 union select 16 union select 17 union select 18 union select 19 union
        select 20 union select 21 union select 22 union select 23) a
        LEFT JOIN (
        SELECT
        DATE_FORMAT ( b.start_time, '%H' ) AS times,
        sum(b.new_plan_count) AS newCount,
        sum(IFNULL ( b.pc_use_plan_count, 0 ) + IFNULL ( b.mobile_use_plan_count, 0 )) AS useCount
        FROM
        data_statistics.bigdata_recommended_plan_statistics_2b_hour b
        where b.is_deleted = 0
        <if test="planType != null and planType != '' ">
            and b.plan_type = #{planType,jdbcType=INTEGER}
        </if>
        <if test="listGroupStyleId != null and listGroupStyleId.size > 0">
            and b.design_style_id in
            <foreach collection="listGroupStyleId" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="spaceCommonType != null and spaceCommonType != '' ">
            and b.space_common_type = #{spaceCommonType,jdbcType=INTEGER}
        </if>
        <if test="companyId != null and companyId != '' ">
            and b.company_id = #{companyId,jdbcType=INTEGER}
        </if>
        <if test="planSource != null  and planSource != '' ">
            and b.plan_source = #{planSource,jdbcType=VARCHAR}
        </if>
        <if test="time == 0">
            and TO_DAYS( NOW( ) ) - TO_DAYS(b.start_time) = 1
        </if>
        GROUP BY
        DATE_FORMAT ( b.start_time, '%H' )
        ORDER BY
        times
        ) c ON a.timehoure = c.times
        ORDER BY
        a.timehoure ASC
    </select>



</mapper>